### NARX (Nonlinear AutoRegressive with eXternal input) 模型的数学原理



原文链接：

https://ww2.mathworks.cn/help/deeplearning/ug/design-time-series-narx-feedback-neural-networks.html?s_tid=srchtitle_site_search_1_NARX+



#### 1. 数学原理

NARX 模型是一种自回归网络，它结合了输出的历史值和外部输入信号的历史值，用于建模动态系统。NARX 模型的基本方程为：
$$
y(t) = f(y(t-1), y(t-2), \dots, y(t-n_y), u(t-1), u(t-2), \dots, u(t-n_u))
$$
其中：

- $y(t)$ 是目标输出信号，表示在时间 $t$ 的系统输出。
- $u(t)$ 是外部输入信号，表示在时间 $t$ 时外部施加的影响。
- $n_y$ 和 $n_u$ 分别表示输出信号和输入信号的延迟时间步数。
- $f$ 是通过神经网络来近似的非线性函数，捕捉时间序列的动态关系。

该模型通过将历史数据和外部输入的历史数据作为输入来预测当前时间步的输出。NARX 模型的核心思想是通过神经网络（通常是前馈神经网络）来学习这种非线性动态关系。

### 2. 任务背景和应用

#### 2.1 任务背景

NARX 模型常用于时间序列预测和动态系统建模，尤其是在存在外部输入（如控制信号、环境变化等）的情况下。它被广泛应用于以下领域：

- **工业控制**：例如在控制系统中，NARX 模型可以预测系统输出（如温度、压力等），并根据外部输入（如加热功率、流量等）调整控制策略。
- **经济学和金融**：预测金融市场中资产价格的变化，基于历史价格（输出）和外部经济因素（输入）。
- **信号处理和噪声过滤**：NARX 模型也可以用来处理带噪声的信号，预测无噪声的信号版本。

#### 2.2 应用实例

- **磁悬浮系统建模**：如代码中的示例，NARX 模型用于建模磁悬浮系统，通过输入电压预测磁体位置。这是一个经典的控制系统问题，涉及通过外部输入（电压）和历史系统输出（位置）来预测未来状态。
- **能源需求预测**：基于天气数据（外部输入）和过去的电力需求（输出），使用 NARX 模型进行未来电力需求的预测。
- **机器人控制**：NARX 模型通过考虑过去的动作（控制输入）和状态（反馈信号）来预测机器人未来的动作。

### 3. 代码实现和注释

以下是使用 MATLAB 实现 NARX 模型的代码注释和详细解释：

```
% 磁悬浮系统数据加载
[u, y] = maglev_dataset; % 加载输入电压和输出磁体位置的时间序列数据

% 创建串并行 NARX 网络
% d1 和 d2 分别为延迟的时间步数，10 表示隐藏层神经元个数
d1 = [1:2];  % 输出信号的延迟时间步数
d2 = [1:2];  % 输入信号的延迟时间步数
narx_net = narxnet(d1, d2, 10);  % 创建NARX网络

% 配置网络训练参数
narx_net.divideFcn = '';  % 不进行数据划分
narx_net.trainParam.min_grad = 1e-10;  % 最小梯度

% 准备训练数据
% preparets 函数格式化数据，以适应网络训练
[p, Pi, Ai, t] = preparets(narx_net, u, {}, y);

% 训练 NARX 网络
narx_net = train(narx_net, p, t, Pi);  % 使用训练数据进行训练

% 仿真网络
yp = sim(narx_net, p, Pi);  % 使用训练好的网络进行仿真

% 计算误差
e = cell2mat(yp) - cell2mat(t);  % 计算仿真输出与实际输出之间的误差

% 绘制误差图
plot(e)  % 显示误差图，评估网络的预测准确性
```

### 3.1 代码解释

1. **数据加载**：从 `maglev_dataset` 加载了两个时间序列，分别代表磁悬浮系统的输入（电压）和输出（磁体的位置）。
2. **创建 NARX 网络**：
   - 使用 `narxnet(d1, d2, 10)` 创建了一个 NARX 网络。`d1` 和 `d2` 分别是输出信号和输入信号的延迟步数，`10` 是隐藏层的神经元个数。
   - 该网络是一个两层前馈神经网络，用来逼近系统的非线性动态行为。
3. **准备训练数据**：
   - 使用 `preparets` 函数来将时间序列数据格式化为适合 NARX 网络训练的形式。`p` 是输入数据，`t` 是目标输出数据，`Pi` 和 `Ai` 分别是初始条件和内部状态。
4. **训练网络**：
   - 使用 `train` 函数对网络进行训练，`p` 和 `t` 是训练数据，`Pi` 是初始条件。训练过程中，网络会优化权重和偏置，以最小化输出误差。
5. **仿真和误差计算**：
   - 使用 `sim` 函数仿真训练后的网络，得到预测输出 `yp`，然后计算预测值与实际值之间的误差 `e`。
6. **绘制误差图**：
   - 最后，绘制误差图，检查模型的预测性能。小的误差表示网络训练成功，能够有效预测系统的行为。

### 3.2 开环与闭环配置

- **开环（串并行架构）**：在训练阶段使用，适用于单步预测。训练网络时，输入仅依赖于历史数据。
- **闭环（并行架构）**：用于多步预测，其中模型的输出会反馈到输入端，形成一个闭环系统。在这种配置下，网络会根据预测的值进行多步预测，适用于实际的动态系统建模。

通过 `closeloop` 函数可以将开环网络转换为闭环网络，以进行多步预测。以下是转换的代码：

```
narx_net_closed = closeloop(narx_net);  % 将网络转换为闭环形式
```

### 4. 总结

NARX 模型是一种强大的工具，广泛应用于动态系统建模，尤其是在需要考虑外部输入的情况下。通过训练前馈神经网络来逼近系统的非线性动态关系，NARX 可以精确地预测未来状态，并在实际控制系统中发挥重要作用。通过串并行架构和闭环配置，NARX 网络能够处理单步和多步预测任务，具有很高的灵活性和适应性。